<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>買い物リスト</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .btn-icon {
            --bs-btn-padding-x: 0rem;
            --bs-btn-padding-y: 0rem;
            --bs-btn-border-width: 0px;
        }

        .text-main {
            color: #31bc92;
        }

        .bg-main-subtle {
            background-color: #ffffff;
        }

        [disabled] {
            filter: grayscale(100%);
        }

        .offcanvas-width-50 {
            /* the default value of --bs-offcanvas-width is 400px.
             * it is defined as $offcanvas-horizontal-width in Saas.
             */
            --bs-offcanvas-width: min(400px, 50vw);
        }
    </style>
</head>

<body>
    <div data-id="rootContainer">
    </div>
    <div class="offcanvas offcanvas-start offcanvas-width-50" tabindex="-1" id="leftMenuBar">
    </div>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const RuntimeConfiguration = {
            debugMode: true,
        };

        class StringsInEnglish {
            static newItemSetName = 'New set';
            static loadPresetLabel = 'Load the preset'
        }
        class StringsInJapanese {
            static newItemSetName = '';
            static loadPresetLabel = 'プリセットのロード'
        }
        let L10n = StringsInJapanese;

        class Item {
            constructor(model, parameter = {}) {
                this.model = model;
                this.deserialize(parameter);
            }

            serialize() {
                return {
                    id: this.id,
                    name: this.name,
                    amount: this.amount,
                    unit: this.unit,
                    belongingTo: this.belongingTo.id,
                };
            }
            deserialize({ id = `item-${window.crypto.randomUUID()}`, name, amount, unit, belongingTo }) {
                this.id = id;
                this.name = name;
                this.amount = amount;
                this.unit = unit;
                if (belongingTo !== undefined && !(belongingTo instanceof ItemSet)) {
                    if (this.model.stagedItemSet !== undefined && belongingTo == this.model.stagedItemSet.id) {
                        belongingTo = this.model.stagedItemSet;
                    } else {
                        belongingTo = this.model.itemSets.get(belongingTo);
                    }
                }
                this.belongingTo = belongingTo;
                return this;
            }

            toString() {
                return `${this.name} ... ${this.amount} ${this.unit}`;
            }
        }
        class ItemArray extends Array {
            constructor(model, parameters = []) {
                super();
                this.model = model;
                this.deserialize(parameters);
            }

            get(id) {
                return this.find(i => i.id == id);
            }

            serialize() {
                return this.map(i => i.serialize());
            }
            deserialize(serializedData) {
                this.empty();
                this.push(...serializedData.map(si => new Item(this.model, si)));
                return this;
            }
        }
        class AggregatedItem {
            constructor(model, parameters = {}) {
                this.model = model;
                this.deserialize(parameters);
            }

            get name() {
                return this.items[0].name;
            }
            get amount() {
                return this.items.reduce((total, item) => total + item.amount, 0);
            }
            get unit() {
                return this.items[0].unit;
            }

            serialize() {
                return {
                    id: this.id,
                    items: this.items.map(i => i.id),
                };
            }
            deserialize({ id = `aggregated-item-${window.crypto.randomUUID()}`, items = [] }) {
                this.id = id;
                this.items = items.map(i => i instanceof Item ? i : this.model.items.get(i));
                return this;
            }

            toString() {
                return `${this.name} ... ${this.amount} ${this.unit}`;
            }
        }
        class AggregatedItemArray extends Array {
            constructor(model, parameters = []) {
                super();
                this.model = model;
                this.deserialize(parameters);
            }

            get(id) {
                return this.find(i => i.id == id);
            }

            serialize() {
                return this.map(i => i.serialize());
            }
            deserialize(serializedData) {
                this.empty();
                this.push(...serializedData.map(si => new AggregatedItem(this.model, si)));
                return this;
            }
        }
        class AggregatedItemReferenceArray extends Array {
            constructor(model, parameters = []) {
                super();
                this.model = model;
                this.deserialize(parameters);
            }

            serialize() {
                return this.map(i => i.id);
            }
            deserialize(serializedData) {
                this.empty();
                this.push(...serializedData.map(id => this.model.shoppingItems.get(id)));
                return this;
            }
        }
        class ItemSet {
            constructor(model, parameters = {}) {
                this.model = model;
                this.deserialize(parameters);
            }

            toString() {
                return this.name;
            }

            serialize() {
                return {
                    id: this.id,
                    name: this.name,
                };
            }
            deserialize({ id = `itemSet-${window.crypto.randomUUID()}`, name }) {
                this.id = id;
                this.name = name;
                return this;
            }
        }
        class ItemSetArray extends Array {
            constructor(model, parameters = []) {
                super();
                this.model = model;
                this.deserialize(parameters);
            }

            get(id) {
                return this.find(s => s.id == id);
            }

            serialize() {
                return this.map(is => is.serialize());
            }
            deserialize(serializedData) {
                this.empty();
                this.push(...serializedData.map(sis => new ItemSet(this.model, sis)));
                return this;
            }
        }
        class ItemSetReferenceArray extends Array {
            constructor(model, parameters = []) {
                super();
                this.model = model;
                this.deserialize(parameters);
            }

            serialize() {
                return this.map(is => is.id);
            }
            deserialize(serializedData) {
                this.empty();
                this.push(...serializedData.map(id => this.model.itemSets.get(id)));
                return this;
            }
        }
        class Model {
            constructor() {
                this.items = new ItemArray(this);
                this.itemSets = new ItemSetArray(this);
                this.selectedItemSets = new ItemSetReferenceArray(this);
                this.shoppingItems = new AggregatedItemArray(this);
                this.selectedShoppingItems = new AggregatedItemReferenceArray(this);
                this.stagedItemSet = undefined;
                this.stagedItems = undefined;
            }

            serialize() {
                return {
                    itemSets: this.itemSets.map(s => s.serialize()),
                    items: this.items.map(i => i.serialize()),
                    selectedItemSets: this.selectedItemSets.serialize(),
                    shoppingItems: this.shoppingItems.serialize(),
                    selectedShoppingItems: this.selectedShoppingItems.serialize(),
                    stagedItemSet: this.stagedItemSet !== undefined ? this.stagedItemSet.serialize() : undefined,
                    stagedItems: this.stagedItems !== undefined ? this.stagedItems.serialize() : undefined,
                }
            }
            deserialize({ itemSets = [], items = [], selectedItemSets = [], shoppingItems = [], selectedShoppingItems = [], stagedItemSet, stagedItems }) {
                this.itemSets.deserialize(itemSets);
                this.items.deserialize(items);
                this.selectedItemSets.deserialize(selectedItemSets);
                this.shoppingItems.deserialize(shoppingItems);
                this.selectedShoppingItems.deserialize(selectedShoppingItems);
                if (stagedItemSet !== undefined) {
                    this.stagedItemSet = new ItemSet(this, stagedItemSet);
                }
                if (stagedItems !== undefined) {
                    this.stagedItems = new ItemArray(this, stagedItems);
                }
            }
        }

        class NonVolatileModelStore {
            constructor(model) {
                this.model = model;
            }

            save() {
                localStorage['model'] = JSON.stringify(this.model.serialize());
            }
            load() {
                this.model.deserialize(JSON.parse(localStorage['model']));
            }
        }

        class AbstractView {
            get controller() {
                return this._controller;
            }
            set controller(controller) {
                this._controller = controller;
            }

            get model() {
                return this._controller.model;
            }
            get view() {
                return this._controller.view;
            }

            show() {
                this.$element.show();
            }
            hide() {
                this.$element.hide();
            }

            createIconButton({ type = 'push', size = 'normal', icon, off, on, toggleState = false }) {
                return $('<button>')
                    .addClass('btn')
                    .css({
                        normal: {
                            '--bs-btn-border-width': '0px',
                        },
                        fit: {
                            '--bs-btn-padding-x': '0px',
                            '--bs-btn-padding-y': '0px',
                            '--bs-btn-border-width': '0px',
                        },
                    }[size])
                    .attr({
                        push: {},
                        toggle: {
                            'data-toggled': true,
                            'data-toggle-state': toggleState,
                        },
                    }[type])
                    .append(
                        [icon, off, on]
                            .filter(c => c !== undefined)
                            .map(c => $('<i>').addClass(c)));
            }

            createCheckButton({ off = 'fs-4 bi bi-circle', on = 'fs-4 bi bi-check-circle-fill text-main', state = false }) {
                return this.createIconButton({
                    type: 'toggle',
                    size: 'fit',
                    off: off,
                    on: on,
                    toggleState: state,
                });
            }

            _updateOnce() {
                this.$element = $('<div>');
            }

            _update(...updatedModels) {
            }

            _isUpdateNeeded(...updatedModels) {
                return true;
            }

            update(...updatedModels) {
                if (!this._isUpdateNeeded()) return;

                if (!this._initialized) {
                    this._updateOnce();
                    this._initialized = true;
                }

                this._update(...updatedModels);
            }
        }
        class BaseView extends AbstractView {
            _updateOnce() {
                super._updateOnce();

                const myself = this;
                this.$headerPanel = $('<div>')
                    .addClass('row bg-main-subtle');
                this.$headerContainer = $('<div>')
                    .addClass('container-fluid p-0')
                    .append(this.$headerPanel);

                this.$bodyPanel = $('<div>')
                    .addClass('container-fluid px-0')
                    .data({
                        adjusted: false,
                        previousScrollTop: 0,
                    });

                this.$footerPanel = $('<div>')
                    .addClass('d-flex justify-content-around bg-main-subtle');
                this.$footerContainer = $('<div>')
                    // d-flex needs to wrap by a div because hide() does not work for d-flex.
                    .addClass('container-fluid p-0 fixed-bottom')
                    .append(this.$footerPanel);

                this.$element
                    // d-flex needs to wrap by a div because hide() does not work for d-flex.
                    .addClass('container-fluid p-0')
                    .append(
                        $('<div>')
                            .addClass('d-flex flex-column')
                            .append(this.$headerContainer, this.$bodyPanel, this.$footerContainer));

                // The code adds paddings to the body after the header and the footer sizes are determined.
                // That processing must not be done in the event handler of scroll
                // because a scroll bar will not be shown and some items in the bottom will be hide by the footer
                // in the following conditions:
                //     - [header size] + [body size] < [viewport size]
                //     - [header size] + [body size] > [viewport size] - [footer size]
                new IntersectionObserver(entries =>
                    entries
                        .filter(entry => entry.isIntersecting)
                        .filter(() => this.$headerContainer.height() > 0 || this.$footerContainer.height() > 0)
                        .forEach(entry => {
                            if (!this.$headerContainer.hasClass('fixed-top')) {
                                this.$headerContainer.addClass('fixed-top');
                            }
                            this.$bodyPanel.css({ 'padding-top': `${this.$headerContainer.innerHeight()}px` });
                            this.$bodyPanel.css({ 'padding-bottom': `${this.$footerContainer.innerHeight()}px` });
                        }))
                    .observe(this.$element[0]);

                this.previousScrollTop = 0;
                this.changeHeaderAndFooterViewByScrollPosition = function () {
                    // The code absorbs differences between browsers.
                    // More details: https://ja.javascript.info/size-and-scroll-window
                    const scrollHeight = Math.max(
                        document.body.scrollHeight, document.documentElement.scrollHeight,
                        document.body.offsetHeight, document.documentElement.offsetHeight,
                        document.body.clientHeight, document.documentElement.clientHeight,
                    );
                    const clientHeight = window.innerHeight;
                    const scrollTop = window.pageYOffset;

                    // Scroll can be bounced in iOS-Safari.
                    // This is why the following code checks if the scroll position is at the bottom when scrolling up.
                    const scrolledToTop = scrollTop <= 0;
                    const scrolledToBottom = scrollHeight - clientHeight - scrollTop <= 1;
                    const scrolledUp = myself.previousScrollTop > scrollTop;
                    if (scrolledToTop || (scrolledUp && !scrolledToBottom)) {
                        myself.$headerContainer.show();
                        myself.$footerContainer.show();
                    } else {
                        myself.$headerContainer.fadeOut();
                        myself.$footerContainer.hide();
                    }

                    myself.previousScrollTop = scrollTop;
                };
            }

            show() {
                super.show();
                $(window).scroll(this.changeHeaderAndFooterViewByScrollPosition);
            }
            hide() {
                super.hide();
                window.removeEventListener('scroll', this.changeHeaderAndFooterViewByScrollPosition);
            }
        }
        class ShoppingListView extends BaseView {
            _updateOnce() {
                super._updateOnce();

                const myself = this;
                // it seems that bootstrap.Offcanvs.hide() dows not work
                // when the boostrap.Offcanvas instance was created in the click event handler.
                // I have not find its reason yet.
                const bsOffcanvas = new bootstrap.Offcanvas($('#leftMenuBar')[0]);
                $('#leftMenuBar').append(
                    $('<div>')
                        .addClass('offcanvas-header p-0')
                        .append(this.createIconButton({ icon: 'fs-2 bi bi-arrow-left-circle text-secondary' })
                            .click(function () {
                                bsOffcanvas.hide();
                            })),
                    $('<div>')
                        .addClass('offcanvas-body p-0')
                        .append($('<div>')
                            .addClass('list-group list-group-flush')
                            .append(
                                $('<button>')
                                    .addClass('list-group-item list-group-item-action')
                                    .attr({ type: 'button' })
                                    .text(L10n.loadPresetLabel)
                                    .click(function () {

                                    }))));
                this.$showLeftMenuBarButton = this.createIconButton({ icon: 'fs-1 bi bi-list text-main' })
                    .attr({
                        'data-bs-toggle': 'offcanvas',
                        'data-bs-target': '#leftMenuBar',
                    });
                this.$headerPanel
                    .append(
                        $('<div>')
                            .addClass('col text-left')
                            .append(this.$showLeftMenuBarButton),
                        $('<div>')
                            .addClass('col text-center')
                            .append($('<i>').addClass('fs-1 bi bi-bag text-main')),
                        $('<div>')
                            .addClass('col text-right'));
                this.$showItemSetSelectionViewButton = this.createIconButton({ icon: 'fs-1 bi bi-journals text-main' })
                    .click(function () {
                        myself.view.switchOver(myself.view.itemSetSelectionView);
                    });
                this.$copyButton = $('<div>')
                    .addClass('position-relative')
                    .append(
                        this.createIconButton({ icon: 'fs-1 bi bi-clipboard text-main' }),
                        this.createIconButton({ icon: 'fs-1 bi bi-clipboard-check-fill text-main' })
                            .addClass('position-absolute top-0 start-0')
                            .hide())
                    .click(function () {
                        myself.controller.writeCurrentShoppingListToClipboard();
                        $(this).children().eq(1).show().fadeOut(1000);
                    });
                this.$footerPanel.append(
                    this.$showItemSetSelectionViewButton,
                    $('<div>'),
                    $('<div>'),
                    $('<div>'),
                    this.$copyButton);
            }

            _update(...updatedModels) {
                super._update(...updatedModels);

                const myself = this;
                this.$bodyPanel.empty();
                this.$bodyPanel.append(
                    this.model.shoppingItems.map(item =>
                        $('<div>')
                            .addClass('containter-fluid px-3 d-flex align-items-center')
                            .append(
                                this.createCheckButton({ state: this.model.selectedShoppingItems.includes(item) })
                                    .click(function () {
                                        myself.controller.run('changeShoppingItemSelectionState', item, $(this).data('toggle-state'));
                                    }),
                                $('<div>')
                                    .addClass('ps-3')
                                    .text(item.toString())
                                    .click(function () {
                                        $(this).prev().click();
                                    }))));
            }

            _isUpdateNeeded(...updatedModels) {
                return updatedModels.length == 0 || updatedModels.some(m => [this.model, this.model.shoppingItems].includes(m));
            }
        }
        class ItemSetSelectionView extends BaseView {
            _updateOnce() {
                super._updateOnce();

                const myself = this;
                this.$backButton = this.createIconButton({ icon: 'fs-2 bi bi-arrow-left-circle text-secondary' })
                    .click(function () {
                        myself.view.switchOver(myself.view.shoppingListView);
                    })
                this.$headerPanel.append(
                    $('<div>')
                        .addClass('col text-left')
                        .append(this.$backButton),
                    $('<div>')
                        .addClass('col text-center')
                        .append($('<i>').addClass('fs-1 bi bi-journals text-main')),
                    $('<div>')
                        .addClass('col text-right'));
                this.$itemsContainer = $('<div>').addClass('containter-fluid px-3');
                this.$bodyPanel.append(this.$itemsContainer);
                this.$addButton = this.createIconButton({ icon: 'fs-1 bi bi-journal-plus text-main' })
                    .click(function () {
                        myself.controller.run('stageItemSet', new ItemSet());
                        myself.view.switchOver(myself.view.itemSetAdditionView);
                    });
                this.$changeModeButton = this.createIconButton({
                    type: 'toggle',
                    off: 'fs-1 bi bi-pencil-square text-main',
                    on: 'fs-1 bi bi-list-ul text-main'
                })
                    .click(function () {
                        myself.update();
                    });
                this.$footerPanel.append(
                    this.$addButton,
                    $('<div>'),
                    $('<div>'),
                    $('<div>'),
                    this.$changeModeButton,
                );
            }

            _update(...updatedModels) {
                super._update(...updatedModels);

                const myself = this;
                this.$itemsContainer.empty();
                this.$itemsContainer.append(
                    this.model.itemSets.map(itemSet =>
                        $('<div>')
                            .addClass('row')
                            .append(
                                $('<div>')
                                    .addClass('col-auto d-flex align-items-center')
                                    .append(this.createCheckButton({
                                        on: 'fs-4 bi bi-plus-circle-fill text-main',
                                        state: this.model.selectedItemSets.includes(itemSet)
                                    })
                                        .click(function () {
                                            myself.controller.run('changeItemSetSelectionState', itemSet, $(this).data('toggle-state'));
                                        })),
                                $('<div>')
                                    .addClass('col ps-0 d-flex align-items-center')
                                    .text(itemSet.toString())
                                    .click(function () {
                                        $(this).prev().children(':first').click();
                                    }),
                                $('<div>')
                                    .addClass('col-auto p-0 d-flex align-items-center')
                                    .append(
                                        this.createIconButton({ icon: 'fs-4 bi bi-pencil-fill text-main', size: 'fit' })
                                            .toggle(this.$changeModeButton.data('toggle-state'))
                                            .click(function () {
                                                myself.controller.run('stageItemSet', itemSet);
                                                myself.view.switchOver(myself.view.itemSetAdditionView);
                                            })),
                                $('<div>')
                                    .addClass('col-auto d-flex align-items-center')
                                    .append(
                                        this.createIconButton({ icon: 'fs-4 bi bi-dash-circle-fill text-danger', size: 'fit' })
                                            .toggle(this.$changeModeButton.data('toggle-state'))
                                            .click(function () {
                                                myself.controller.run('removeItemSet', itemSet);
                                            })))));
            }

            _isUpdateNeeded(...updatedModels) {
                return updatedModels.length == 0 || updatedModels.some(m => [this.model, this.model.itemSets].includes(m));
            }
        }
        class ItemSetAdditionView extends BaseView {
            _updateOnce() {
                super._updateOnce();

                const myself = this;
                this.$backButton = this.createIconButton({ icon: 'fs-2 bi bi-x-circle text-secondary' })
                    .click(function () {
                        myself.controller.run('unstageItemSet');
                        myself.view.switchOver(myself.view.itemSetSelectionView);
                    })
                this.$headerPanel.append(
                    $('<div>')
                        .addClass('col text-start')
                        .append(this.$backButton),
                    $('<div>'));
                this.$nameInput = $('<input>')
                    .addClass('form-control border-0')
                    .css({ 'font-size': '1.5rem' })
                    .attr({ type: 'text' });
                this.$itemsContainer = $('<div>');
                this.$bodyPanel
                    .append(
                        $('<div>')
                            .addClass('container-fluid')
                            .append(
                                $('<div>')
                                    .addClass('row mt-1')
                                    .append(
                                        $('<div>').addClass('col-auto'),
                                        $('<div>')
                                            .addClass('col')
                                            .append(this.$nameInput)),
                                $('<div>')
                                    .addClass('row')
                                    .append(
                                        $('<div>')
                                            .addClass('col-auto')
                                            .append($('<i>').addClass('bi bi-basket3 text-main')),
                                        $('<div>')
                                            .addClass('col')
                                            .append(this.$itemsContainer)),
                                $('<div>')
                                    .addClass('row')
                                    .append(
                                        $('<div>').addClass('col-auto'),
                                        $('<div>')
                                            .addClass('col')
                                            .append($('<button>')
                                                .addClass('btn')
                                                .attr({ type: 'button' })
                                                .text('追加2')
                                                .click(function () {
                                                    myself.controller.run('addItemSet', myself.$nameInput.val(), myself.model.stagedItems);
                                                })))));
            }

            _update(...updatedModels) {
                super._update(...updatedModels);

                this.$nameInput.val(this.model.stagedItemSet ? this.model.stagedItemSet.name : '');
                this.$itemsContainer
                    .empty()
                    .append((this.model.stagedItems ?? []).map(item => $('<div>').text(item.toString())));
            }

            _isUpdateNeeded(...updatedModels) {
                return updatedModels.length == 0 || updatedModels.some(m => [this.model, this.model.stagedItems].includes(m));
            }
        }
        class ItemAdditionView extends AbstractView {
            _updateOnce() {
                super._updateOnce();

                const myself = this;
                this.$element = $('<div>');
                this.$nameInput = $('<input>')
                    .addClass('form-control')
                    .attr({ type: 'text' });
                this.$amountInput = $('<input>')
                    .addClass('form-control')
                    .attr({ type: 'text' });
                this.$unitInput = $('<input>')
                    .addClass('form-control')
                    .attr({ type: 'text' });
                this.$element.append(
                    this.$nameInput,
                    this.$amountInput,
                    this.$unitInput,
                    $('<button>')
                        .addClass('btn')
                        .attr({ type: 'button' })
                        .text('追加3')
                        .click(function () {
                            myself.controller.run('stageItem', {
                                name: myself.$nameInput.val(),
                                amount: myself.$amountInput.val(),
                                unit: myself.$unitInput.val(),
                            });
                        }));
            }
        }
        class AbstractViewPane extends AbstractView {
            constructor() {
                super();
                this.shoppingListView = new ShoppingListView();
                this.itemSetSelectionView = new ItemSetSelectionView();
                this.itemSetAdditionView = new ItemSetAdditionView();
                this.itemAdditionView = new ItemAdditionView();
            }

            set controller(controller) {
                super.controller = controller;
                this.views.forEach(v => v.controller = controller);
            }

            get views() {
                return [
                    this.shoppingListView,
                    this.itemSetSelectionView,
                    this.itemAdditionView,
                    this.itemSetAdditionView,
                ];
            }

            switchOver(view) {
            }

            _updateOnce() {
                this.views.forEach(v => v.update());
                this.$element = $('[data-id="rootContainer"]');
            }

            _update(...updatedModels) {
                this.views.forEach(v => v.update(...updatedModels));
            }
        }
        class SingleViewPane extends AbstractViewPane {
            _updateOnce() {
                super._updateOnce();

                this.$element
                    .addClass('container-fluid p-0')
                    .append(this.views.map(v => v.$element));
                this.switchOver(this.shoppingListView);
            }

            switchOver(view) {
                this.views.forEach(v => {
                    if (v === view) {
                        v.show();
                        v.update();
                    } else {
                        v.hide();
                    }
                });
            }
        }
        class FlexViewPane extends AbstractViewPane {
            _updateOnce() {
                super._updateOnce();

                const $template = $('<div>').css({
                    width: '372px',
                    'min-width': '372px',
                    'max-width': '372px',
                    height: '625px',
                    'min-height': '625px',
                    'max-height': '625px',
                    border: '1px solid red',
                });
                this.$element
                    .addClass('container-fluid p-0')
                    .append(
                        $('<div>')
                            .addClass('container-fluid p-0 d-flex flex-wrap')
                            .append(this.views.map(v => $template.clone().append(v.$element))));
            }
        }

        class Controller {
            constructor(model, view) {
                this.model = model;
                this.view = view;
                this.modelStore = new NonVolatileModelStore(model);

                this.view.controller = this;
                this.view.update();
            }

            run(command, ...args) {
                const changedModels = {
                    changeItemSetSelectionState: (...args) => this.changeItemSetSelectionState(...args),
                    changeShoppingItemSelectionState: (...args) => this.changeShoppingItemSelectionState(...args),
                    addItemSet: (...args) => this.addItemSet(...args),
                    removeItemSet: (...args) => this.removeItemSet(...args),
                    stageItemSet: (...args) => this.stageItemSet(...args),
                    unstageItemSet: (...args) => this.unstageItemSet(...args),
                    stageItem: (...args) => this.stageItem(...args),
                    loadModel: (...args) => this.loadModel(...args),
                }[command](...args);
                this.view.update(...changedModels);
                this.modelStore.save();
            }

            changeShoppingItemSelectionState(item, selected) {
                selected ? this.model.selectedShoppingItems.push(item) : this.model.selectedShoppingItems.remove(item);
                return [this.model.selectedShoppingItems];
            }

            changeItemSetSelectionState(itemSet, selected) {
                if (selected) {
                    this.model.selectedItemSets.push(itemSet);
                    this.model.items.filter(i => i.belongingTo == itemSet).forEach(i => {
                        let aggregatedItem = this.model.shoppingItems.find(ai => i.name == ai.name && i.unit == ai.unit);
                        if (aggregatedItem === undefined) {
                            aggregatedItem = new AggregatedItem(this.model);
                            this.model.shoppingItems.push(aggregatedItem);
                        }
                        aggregatedItem.items.push(i);
                    });
                } else {
                    this.model.selectedItemSets.remove(itemSet);
                    this.model.shoppingItems.forEach(ai => ai.items.removeIf(i => i.belongingTo == itemSet));
                    this.model.shoppingItems.removeIf(ai => ai.items.length == 0);
                }
                this.model.selectedShoppingItems.removeIf(ai => !this.model.shoppingItems.includes(ai));
                return [this.model.shoppingItems, this.model.selectedShoppingItems, this.model.selectedItemSets];
            }

            addItemSet(parameters) {
                this.model.itemSets.push(new ItemSet(this.model, parameters));
                return [this.model.itemSets];
            }
            removeItemSet(itemSet) {
                const changedModels = this.changeItemSetSelectionState(itemSet, false);
                this.model.items.removeIf(i => i.belongingTo == itemSet.id);
                this.model.itemSets.remove(itemSet);
                return changedModels.concat([this.model.itemSets]);
            }

            addItemToItemSet(item, itemSet) {
                item.belongingTo = itemSet;
                this.model.items.push(item);
                return [this.model.items];
            }

            stageItemSet(itemSet) {
                this.model.stagedItemSet = Object.assign(new ItemSet(), itemSet);
                this.model.stagedItems = undefined;
                const changedModels = this.model.items
                    .filter(i => i.belongingTo === itemSet)
                    .map(i => this.stageItem(i));
                return changedModels.concat([this.model.stageItemSet, this.model.stagedItems]);
            }
            unstageItemSet() {
                this.model.stagedItemSet = undefined;
                this.model.stagedItems = undefined;
                return [this.model.stageItemSet, this.model.stagedItems];
            }
            stageItem(item) {
                this.model.stagedItems ??= new ItemArray(this.model);

                let serialized_item = item.serialize();
                serialized_item.belongingTo = this.model.stagedItemSet.id;
                this.model.stagedItems.push(new Item(this.model, serialized_item));
                return [this.model.stagedItems]
            }

            writeCurrentShoppingListToClipboard() {
                const text = this.model.selectedItemSets.map(s => s.name).join('\n')
                    + '\n'
                    + this.model.shoppingItems.map(i => i.toString()).join('\n');
                navigator.clipboard.writeText(text);
            }

            saveModel() {
                this.modelStore.save();
            }
            loadModel() {
                this.modelStore.load();
                return [this.model];
            }
        }

        class BuiltinObjectsExtension {
            // Safari bundled in iOS 16 does not support Object.groupBy function yet.
            static defineObjectGroupBy(force = false) {
                if (Object.groupBy !== undefined && !force) return;

                Object.groupBy = function (items, callbackFn) {
                    let groupedItems = {};
                    items.forEach(item => {
                        const key = callbackFn.call(this, item).toString();
                        if (!(key in groupedItems)) {
                            groupedItems[key] = [];
                        }
                        groupedItems[key].push(item);
                    });
                    return groupedItems;
                }
            }

            // Safari bundled in iOS 16 does not support window.crypto.randomUUID function yet,
            // or the browser only allows calling the function in https.
            static defineWindowCryptoRandomUUID(force = false) {
                if (window.crypto !== undefined && window.crypto.randomUUID !== undefined && !force) return;

                if (window.crypto === undefined) {
                    window.crypto = new Object();
                }

                // The following function will generate a UUID with variant 10x and version 4 defined in RFC-4122.
                window.crypto.randomUUID = function () {
                    let random_numbers = new Uint8Array(16);
                    window.crypto.getRandomValues(random_numbers);
                    random_numbers[6] = 0x40 | (random_numbers[6] & 0x0f);
                    random_numbers[8] = 0x80 | (random_numbers[8] & 0x3f);
                    random_numbers = Array.from(random_numbers);
                    return 'xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx'.replaceAll('xx', s => random_numbers.shift().toString(16).padStart(2, '0'));
                }
            }

            // Safari bundled in iOS 16 does not support navigator.clipboard.writeText function yet.
            static defineNavigatorClipboardWriteText(force = false) {
                if (navigator.clipboard !== undefined && navigator.clipboard.writeText != undefined && !force) return;

                if (navigator.clipboard === undefined) {
                    navigator.clipboard = new Object();
                }

                navigator.clipboard.writeText = function (text) {
                    const $textarea = $('<textarea>').val(text);
                    const $element = $('<div>').append($textarea);
                    $('body').append($element);
                    const selection = window.getSelection();
                    selection.selectAllChildren($element[0]);   // Safari bundled iOS requires selection in this way.
                    document.execCommand('copy');
                    $element.remove();
                }
            }

            static defineArrayPrototypeEmpty(force = false) {
                if (Array.prototype.empty !== undefined) return;

                Array.prototype.empty = function () {
                    // splice() will call constructor().
                    // constructor() of models that inherit Array class calls this method via deserialize().
                    // This is why this guard is required.
                    // It prevents infinite loop when models that inherit Array class are created.
                    if (this.length == 0) return;
                    this.splice(0);
                }
            }

            static defineArrayPrototypeRemove(force = false) {
                if (Array.prototype.remove !== undefined) return;

                Array.prototype.remove = function (value) {
                    let lastRemovedElement = undefined;
                    for (; ;) {
                        const i = this.indexOf(value);
                        if (i == -1) break;

                        lastRemovedElement = this[i];
                        this.splice(i, 1);
                    }
                    return lastRemovedElement;
                }
            }

            static defineArrayPrototypeRemoveIf(force = false) {
                if (Array.prototype.removeIf !== undefined) return;

                Array.prototype.removeIf = function (callbackFn, thisArg) {
                    let lastRemovedElement = undefined;
                    for (; ;) {
                        const i = this.findIndex(callbackFn, thisArg);
                        if (i == -1) break;

                        lastRemovedElement = this[i];
                        this.splice(i, 1);
                    }
                    return lastRemovedElement;
                }
            }
        }

        class Togglizer {
            static enable_auto_togglize() {
                this.togglize($('[data-toggled="true"]'));
                (new MutationObserver(mutations => mutations
                    .map(mutation => $(mutation.addedNodes).find('[data-toggled="true"]'))
                    .forEach(node => this.togglize($(node)))))
                    .observe(document.getElementsByTagName('body')[0], { childList: true, subtree: true });
            }

            static togglize($elements) {
                $elements.each(function () {
                    const $element = $(this);
                    if ($element.data('toggle-initialized')) return;

                    // This observing should start before adding data-toggle-state attribute to $element
                    // in order to match its state and its display.
                    (new MutationObserver(mutations => mutations
                        .map(mutation => $(mutation.target))
                        .forEach($target => {
                            const toggleState = JSON.parse($target.attr('data-toggle-state'));
                            $target.children(toggleState ? ':first' : ':last').hide();
                            $target.children(toggleState ? ':last' : ':first').show();
                            $target.data({ 'toggle-state': toggleState });
                        })))
                        .observe(this, { attributes: true, attributeFilter: ['data-toggle-state'] });

                    let handlers = $._data(this, 'events') ? $._data(this, 'events').click.map(handler => handler.handler) : [];
                    handlers.forEach(handler => $element.off('click', handler));
                    $element
                        .attr({ 'data-toggle-state': $element.attr('data-toggle-state') ?? 'false' })
                        .click(function () {
                            const newToggleState = !JSON.parse($element.attr('data-toggle-state'));
                            $element.attr({ 'data-toggle-state': newToggleState });
                            $element.data({ 'toggle-state': newToggleState });
                        });
                    handlers.forEach(handler => $element.on('click', handler));

                    $element.data({ 'toggle-initialized': true });
                })
            }
        }

        class Platform {
            static isSmartPhone() {
                return navigator.userAgent.match(/iPhone|Android.+Mobile/);
            }

            static isIOS() {
                return navigator.userAgent.match(/iPhone|iPad/);
            }
        }

        $(function () {
            BuiltinObjectsExtension.defineObjectGroupBy();
            BuiltinObjectsExtension.defineWindowCryptoRandomUUID();
            BuiltinObjectsExtension.defineNavigatorClipboardWriteText();
            BuiltinObjectsExtension.defineArrayPrototypeEmpty();
            BuiltinObjectsExtension.defineArrayPrototypeRemove();
            BuiltinObjectsExtension.defineArrayPrototypeRemoveIf();

            Togglizer.enable_auto_togglize();

            const model = new Model();
            const view = new SingleViewPane();
            const controller = new Controller(model, view);
            //loadPresetData(model);
            //controller.saveModel();
            controller.run('loadModel');
        })

        function loadPresetData(model) {
            const presetData = {
                インドカレー: [
                    ['鶏もも肉', 300, 'g'],
                    ['玉ねぎ', 1, '個'],
                    ['ニンジン', 1, '本'],
                    ['トマト缶', 1, '缶'],
                ],
                ベーコンとほうれん草: [
                    ['平ベーコン', 1, 'パック'],
                    ['冷凍ほうれん草', 0.5, '袋'],
                    ['厚あげ', 1, '個'],
                    ['かつお節', 1, '袋'],
                ],
                鮭しめじ: [
                    ['鮭', 2, '切れ'],
                    ['しめじ', 2, '株'],
                ],
                プルコギ: [
                    ['豚こま', 250, 'g'],
                    ['ニンジン', 1, '本'],
                    ['ピーマン', 4, '個'],
                ],
                豚キャベツ: [
                    ['豚こま', 250, 'g'],
                    ['キャベツ', 0.25, '個'],
                ],
                豚生姜焼き: [
                    ['豚こま', 250, 'g'],
                    ['玉ねぎ', 1, '個'],
                    ['刻み青ねぎ', 1, 'パック'],
                ],
                鶏ねぎ: [
                    ['鶏もも肉', 300, 'g'],
                    ['白ねぎ', 1, '本'],
                ],
                麻婆: [
                    ['豚挽肉', 300, 'g'],
                    ['しいたけ', 1, 'パック'],
                    ['白ねぎ', 1, '本'],
                ],
                親子丼: [
                    ['鶏もも肉', 300, 'g'],
                    ['エリンギ', 1, 'パック'],
                    ['玉ねぎ', 1, '個'],
                ],
                ナポリタン: [
                    ['ソーセージ', 1, '袋'],
                    ['エリンギ', 1, 'パック'],
                    ['ピーマン', 4, '個'],
                    ['グラタンの素', 1, '箱'],
                ],
                カルボナーラ: [
                    ['角ベーコン', 1, 'パック'],
                    ['エリンギ', 1, 'パック'],
                    ['カルボナーラソース', 1, 'パック'],
                ],
                ラザニア: [
                    ['合挽肉', 300, 'g'],
                    ['ラザニアの素', 1, '箱'],
                    ['刻みチーズ', 1, '袋'],
                ],
                オムライス: [
                    ['ソーセージ', 1, '袋'],
                    ['マッシュルーム', 100, 'g'],
                    ['コーン缶', 1, '缶'],
                    ['卵', 3, '個'],
                    ['バター', 2, '個'],
                ],
                ドリア: [
                    ['ソーセージ', 1, '袋'],
                    ['マッシュルーム', 100, 'g'],
                    ['刻みチーズ', 1, '袋'],
                    ['卵', 2, '個'],
                ],
                三食丼: [
                    ['鶏もも挽肉', 250, 'g'],
                    ['冷凍ほうれん草', 0.5, '袋'],
                    ['卵', 3, '個'],
                ],
                焼きそば: [
                    ['豚こま', 250, 'g'],
                    ['焼きそば麺', 1.5, '袋'],
                    ['カット野菜', 1, '袋'],
                ],
                グラタン: [
                    ['鶏もも肉', 300, 'g'],
                    ['玉ねぎ', 1, '個'],
                    ['グラタンの素', 1, '箱'],
                    ['刻みチーズ', 1, '袋'],
                    ['バター', 2, '個'],
                ],
                うどん: [
                    ['冷凍うどん', 1, 'パック'],
                    ['きつねあげ', 1, 'パック'],
                    ['乾燥わかめ', 4, 'つまみ'],
                    ['卵', 2, '個'],
                    ['天ぷら', 3, '個'],
                    ['メンチカツ', 2, '個'],
                ],
                ミートパスタ: [
                    ['ミートソース', 1, '袋'],
                    ['合挽肉', 300, 'g'],
                    ['エリンギ', 1, 'パック'],
                ],
                ロコモコ丼: [
                    ['合挽肉', 300, 'g'],
                    ['エリンギ', 1, 'パック'],
                    ['卵', 2, '個'],
                    ['千切りキャベツ', 1, '袋'],
                ],
                豚キムチ: [
                    ['豚こま', 300, 'g'],
                    ['キムチ', 1, 'パック'],
                ],
            };
            model.itemSets.push(...Object.keys(presetData).map(name => new ItemSet(model, { name: name })));
            model.items.push(...model.itemSets.flatMap(
                list => presetData[list.name].map(p => new Item(model, { name: p[0], amount: p[1], unit: p[2], belongingTo: list }))
            ));
        }
    </script>
</body>

</html>